<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="treat">
  
  <select id="getCnt" resultType="int">
  	SELECT COUNT (NO)
  	FROM PATIENT
  </select>
  
  <select id="getCnt2" resultType="int">
  	SELECT COUNT (NO)
  	FROM TM_HISTORY
  	WHERE PA_NO = #{no}
  </select>
  
  <!-- 환자 목록조회  -->
  <select id="getPatientList" resultType="PatientVo">
  SELECT 
  	NO
	,PA_NAME
	,PA_TEL
	,RRN
	,PA_GENDER
	,CAREGIVER
	,ADDRESS
	,PA_DATE
	,MEMO
	FROM PATIENT
	<if test="searchType == 'paName'">
		WHERE PA_NAME LIKE '%${searchValue}%'
	</if>
	<if test="searchType == 'rrn'">
		WHERE RRN LIKE '%${searchValue}%'
	</if>
	<if test="searchType == 'paTel'">
		WHERE PA_TEL = #{searchValue}
	</if>
	ORDER BY NO DESC
  </select>
  
  <!-- 환자 상세조회  -->
  <select id="getPatientInquiry" resultType="PatientVo">
		SELECT
		NO
		,PA_NAME
		,PA_TEL
		,RRN
		,PA_GENDER
		,ADDRESS
		,trunc((to_number(to_char(sysdate, 'YYYYMMDD'))-to_number(to_char(decode(substr(RRN, 8, 1), '1', '19', '2', '19', '20')||substr(RRN, 1, 6))))/10000) as "AGE"
		FROM PATIENT
		WHERE NO = #{no}
	</select>
  
  <!-- 환자 정보수정  -->
  <update id="updatePatientInquiry">
		UPDATE PATIENT
	    SET 
	        PA_NAME = #{paName}
	        , PA_TEL = #{paTel}
	        , ADDRESS = #{address}
	    WHERE   NO = #{no}
  </update>
	
  <!-- 환자 상세조회 화묜!!!!  -->
  <select id="getPatientInquiry2" resultType="PatientVo">
		SELECT
		NO
		,PA_NAME
		,PA_TEL
		,ADDRESS
		FROM PATIENT
		WHERE NO = #{no}
	</select>
	
	<!-- 환자 진료내역조회(아래랑 이거중에 뭐가 맞는지 일단 보류)  -->
  <!-- <select id="getPatientChart" resultType="TmHistoryVo">
  SELECT 
  	*
	FROM TM_HISTORY
	WHERE PA_NO = #{paNo}
	ORDER BY NO DESC
  </select> -->
  
  <!-- 환자 진료내역조회 (혹시몰라 일단 둠) -->
  <!-- <select id="getPatientChart" resultType="TmHistoryVo">
  	SELECT
        H.NO
		,H.TM_CONTENT
		,H.FEE
		,H.J_DATE
		,H.CAUTION
		,H.PAID_YN
		,H.PR_CONTENT
		,TO_CHAR(H.PR_DATE, 'YYYY-MM-DD') AS PR_DATE
		,H.DRUG
		,H.PA_NO
		,H.EM_NO
		,P.NO
	FROM TM_HISTORY H
    LEFT JOIN PATIENT P ON (H.PA_NO = P.NO)
	WHERE P.NO = #{no}
	ORDER BY H.NO DESC
  </select> -->
  
  
  <!-- 환자 진료내역조회 (혹시몰라 일단 둠) -->
  <select id="getPatientChart" resultType="TmHistoryVo">
  	SELECT
	    H.NO
	    ,H.TM_CONTENT
	    ,H.FEE
	    ,H.J_DATE
	    ,H.CAUTION
	    ,H.PAID_YN
	    ,H.PR_CONTENT
	    ,TO_CHAR(H.PR_DATE, 'YYYY-MM-DD') AS PR_DATE
	    ,H.DRUG
	    ,H.PA_NO
	    ,H.EM_NO
	    ,P.NO
	    ,E.NAME AS EMPLOYEE_NAME
	    ,D.TITLE AS DEPARTMENT_TITLE
	FROM
	    TM_HISTORY H
	LEFT JOIN
	    PATIENT P ON H.PA_NO = P.NO
	LEFT JOIN
	    EMPLOYEE E ON H.EM_NO = E.NO
	LEFT JOIN
	    DEPARTMENT D ON E.DEPT_NO = D.NO
	WHERE
	    P.NO = #{no}
	ORDER BY
	    H.NO DESC
  </select>
	
	

  

  
  </mapper>